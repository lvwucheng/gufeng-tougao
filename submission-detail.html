<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>投稿详情</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* 保持原有样式不变 */
    body {
      background-color: #f5f7fa;
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }
    .header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    }
    .title {
      font-size: 22px;
      font-weight: 600;
      color: #2c3e50;
    }
    .meta {
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 8px;
    }
    .image-container {
      margin: 24px 0;
    }
    .image-container img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .content {
      line-height: 1.8;
      color: #333;
      margin-bottom: 24px;
    }
    .attachment {
      margin-top: 24px;
    }
    .attachment-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .attachment-icon {
      font-size: 24px;
      color: #3498db;
      margin-right: 12px;
    }
    .attachment-info {
      flex: 1;
    }
    .attachment-name {
      font-size: 15px;
      font-weight: 500;
    }
    .attachment-size {
      font-size: 13px;
      color: #7f8c8d;
      margin-top: 2px;
    }
    .download-btn {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .download-btn:hover {
      background: #2980b9;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .approve {
      background: #2ecc71;
    }
    .reject {
      background: #e74c3c;
    }
    .error-text {
      color: #e74c3c;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title" id="detailTitle">加载中...</h1>
      <div class="meta" id="detailMeta"></div>
    </div>
    <div class="image-container" id="detailImage">
      <p class="text-gray-500">加载封面图中...</p>
    </div>
    <div class="content" id="detailContent">加载内容中...</div>
    <div class="attachment" id="detailAttachment">
      <h3 class="text-lg font-semibold mb-4">附件列表</h3>
      <div id="attachmentList">暂无附件</div>
    </div>
    <div class="actions">
      <button id="approveBtn" class="action-btn approve">审核通过</button>
      <button id="rejectBtn" class="action-btn reject">审核拒绝</button>
    </div>
  </div>

  <script>
    // Supabase 配置
    const SUPABASE_URL = 'https://ojfmwalxryldzcujehav.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qZm13YWx4cnlsZHpjdWplaGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MjUwMzMsImV4cCI6MjA3MDMwMTAzM30.5LNX9PpYnqb5dVR5OKas7qr7zjd10IRSBZop4cuNryM'; // 替换为你的 anon 密钥
    const STORAGE_BUCKET = 'submission-files';

    // 初始化 Supabase 客户端（使用全局 supabase 对象）
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 获取 URL 中的投稿 ID
    const urlParams = new URLSearchParams(window.location.search);
    const submissionId = urlParams.get('id');

    if (!submissionId) {
      alert('缺少投稿 ID，无法查看详情');
      window.location.href = 'admin.html';
    }

    // 页面加载后拉取详情
    document.addEventListener('DOMContentLoaded', () => {
      fetchSubmissionDetail();
    });

    // 拉取投稿详情（使用 Signed URL）
    async function fetchSubmissionDetail() {
  try {
    // 假设已拉取到投稿数据，submission.content 是带换行的纯文本
    const submission = {
      content: "我要是李白多好啊！娶一个宰相的孙女，在她家里一住十年。左手一儿叫伯禽，右手一女叫平阳。每天生活在酒中，闲了赋诗一首，再和道士练飞升。嗨嗨，我不笑醒才怪呢！我把他这十年，总结起来，叫做：“醉隐安陆，洒脱十年”。\n\n“山不在高，有仙则名”。白兆山有仙。谁？李太白先生。白兆山在哪？湖北安陆境内是也。李白从二十五岁到三十五岁，就住在前宰相家里，他看中了他的孙女。李白搬到安陆不久，在白兆山的桃花岩，一边喝酒一边赏着花。有人就问了他一个问题：“你如此才华横溢，又突然有了这样硬的后台，为什么不搬到长安？” 于是，李白写了著名的《山中问答》：问余何意栖碧山，笑而不答心自闲。桃花流水窅然去，别有天地非人间。这里有比桃花源还漂亮的白兆山，我还去哪儿呢？我的面前，是安陆的好汉坡。好汉坡离李白的50米的塑像，有二十里。我叹了口气，李白离我还挺远！奔奔奔！我拾级而上，一边背着不成文的诗：“天生我材必有用，千金散尽还复来”。“人生得意须尽欢，莫使金樽空对月”。汗流浃背。旁边，有知了在“啊啊啊啊啊”地唱。单调地唱，好像只有一只。上气不接下气地唱。不像我们河南的知了，要唱的话，就是一群，“哇哇哇哇哇”地唱，热闹。冷不丁地，一只画眉鸟，突然在我的左耳，鸣叫。吓得我一哆嗦！真幽静啊。有脚步声。一个知识分子模样的人，带着一男一女，从山上下来。“离山顶还有多远？” 我用手抹了抹汗，问其中的那个小孩儿。他忽闪着两只眼睛，迷糊。呵呵，这让我想起了贾岛的一首诗：松下问童子言师采药去只在此山中云深不知处我哈哈哈哈地一乐，继续前行。到了白云泉。当时，李白和宰相的孙女，就住在这里。泉水，像溪流一样，从山缝里绵绵而出。你想啊，李白一天到晚地喝酒，他的那一位，难道不烦？果然。在白云泉的旁边，赫然就有一首李白的诗：《赠内》。在这首诗内，李白很惭愧地说：“虽为李白妇，何异太常妻！” 安陆的人，很充满感情地说：这首诗，是李白写给他妻子的情书，表达了李白对妻子的深厚感情！谁说不是呢。那李白，立在山顶，足有五十米高。好洒脱。他曾经杀过坏人：“十步杀一人，千里不留行。事了拂衣去，深藏身与名”。够潇洒；“大鹏一日同风起，扶摇直上九万里”。够狂妄；“我本楚狂人，凤歌笑孔丘”！真够爷们儿！李白和他在安陆的朋友们，玩得真开心。他写的《安陆白兆山桃花岩寄刘侍御绾》就是极品：“云卧三十年，好闲复爱仙。蓬壶虽冥绝，鸾鹤心悠然。归来桃花岩，得憩云窗眠。……入远构石室，选幽开山田。” 真好！我也不想走了。和李白在一起，真是好！在祖师殿前面，有一颗饱经风霜的银杏，大概有一千四百多年。他不会是李白的化身吧。庄周老先生曾说，银杏是最长寿的树木。一想到这些，我感觉舒服了很多，仿佛自己就是一棵老银杏树。我要成为银杏树，就像一千多年前的李白！李白在安陆，潇洒十年！"
    };

    // 处理换行，将 \n 替换为 <br>
    const formattedContent = submission.content ? submission.content.replace(/\n/g, '<br>') : '无内容';

    // 渲染内容
    const detailContent = document.getElementById('detailContent');
    detailContent.innerHTML = formattedContent;
  } catch (error) {
    console.error('加载详情失败:', error);
    alert('加载详情失败，请重试\n错误原因：' + error.message);
  }
}

        if (!response.ok) {
          throw new Error(`接口响应错误：${response.status}`);
        }

        const submissions = await response.json();
        if (submissions.length === 0) {
          throw new Error('未找到该投稿数据');
        }

        const submission = submissions[0];

        // 填充标题和元信息
        document.getElementById('detailTitle').textContent = submission.title || '无标题';
        document.getElementById('detailMeta').textContent = 
          `作者：${submission.author || '匿名'} | 投稿时间：${new Date(submission.created_at).toLocaleString()}`;

        // 填充封面图（生成 Signed URL）
        const imageContainer = document.getElementById('detailImage');
        if (submission.images && submission.images.length > 0) {
          const imagePath = submission.images[0];
          // 生成带签名的临时图片 URL（有效期 60 秒）
          const { data: signedImage, error: imageError } = await supabase.storage
            .from(STORAGE_BUCKET)
            .createSignedUrl(imagePath, 60);

          if (imageError) throw imageError;

          imageContainer.innerHTML = `
            <img src="${signedImage.signedUrl}" alt="投稿封面图" 
                 onError="this.src=''; this.closest('.image-container').innerHTML='<p class=error-text>图片加载失败，路径：${imagePath}</p>'">
          `;
        } else {
          imageContainer.innerHTML = '<p class="text-gray-500">无封面图</p>';
        }

        // 填充内容
        document.getElementById('detailContent').textContent = submission.content || '无内容';

        // 填充附件（生成 Signed URL）
        const attachmentList = document.getElementById('attachmentList');
        if (submission.file_url) {
          const attachPath = submission.file_url;
          // 生成带签名的临时附件 URL（有效期 60 秒）
          const { data: signedAttach, error: attachError } = await supabase.storage
            .from(STORAGE_BUCKET)
            .createSignedUrl(attachPath, 60);

          if (attachError) throw attachError;

          const filename = attachPath.split('/').pop();
          attachmentList.innerHTML = `
            <div class="attachment-item">
              <div class="attachment-icon">
                <i class="fas fa-file"></i>
              </div>
              <div class="attachment-info">
                <div class="attachment-name">${filename}</div>
                <div class="attachment-size">大小：${formatSize(0)}</div>
              </div>
              <button class="download-btn" data-url="${signedAttach.signedUrl}">
                下载
              </button>
            </div>
          `;

          // 绑定下载事件
          document.querySelector('.download-btn').addEventListener('click', () => {
            window.open(signedAttach.signedUrl, '_blank');
          });
        } else {
          attachmentList.innerHTML = '<p class="text-gray-500">暂无附件</p>';
        }

      } catch (error) {
        console.error('加载详情失败:', error);
        alert('加载详情失败，请重试\n错误原因：' + error.message);
      }
    }

    // 格式化文件大小
    function formatSize(bytes) {
      return bytes < 1024 ? `${bytes} B` : `${(bytes / 1024).toFixed(2)} KB`;
    }

    // 审核通过
    document.getElementById('approveBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions?id=eq.${submissionId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'approved' })
        });

        if (response.ok) {
          alert('审核通过成功');
          window.location.href = 'admin.html';
        } else {
          throw new Error('更新状态失败');
        }
      } catch (error) {
        alert('审核操作失败: ' + error.message);
      }
    });

    // 审核拒绝
    document.getElementById('rejectBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions?id=eq.${submissionId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'rejected' })
        });

        if (response.ok) {
          alert('审核拒绝成功');
          window.location.href = 'admin.html';
        } else {
          throw new Error('更新状态失败');
        }
      } catch (error) {
        alert('审核操作失败: ' + error.message);
      }
    });
  </script>
</body>
</html>
